name: LinkedIn Monitor Agent

on:
  schedule:
    # ExÃ©cution toutes les 12 heures (Ã  8h00 et 20h00 UTC)
    - cron: '0 8,20 * * *'
  workflow_dispatch:  # Permet l'exÃ©cution manuelle
    inputs:
      debug_mode:
        description: 'Activer le mode debug'
        required: false
        default: 'false'

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de sÃ©curitÃ©
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… DÃ©pendances installÃ©es"
    
    - name: ğŸ“Š Check files
      run: |
        echo "ğŸ“‚ Fichiers prÃ©sents:"
        ls -la
        echo "ğŸ“ Contenu du CSV:"
        if [ -f "linkedin_urls.csv" ]; then
          head -5 linkedin_urls.csv
        else
          echo "âŒ Fichier CSV manquant - sera crÃ©Ã© automatiquement"
        fi
    
    - name: ğŸ¤– Run LinkedIn Monitor Agent
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        echo "ğŸš€ Lancement de l'agent LinkedIn..."
        python linkedin_monitor.py
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        # Configuration Git
        git config --local user.email "action@github.com"
        git config --local user.name "LinkedIn Monitor Agent"
        
        # Ajout des fichiers modifiÃ©s
        git add linkedin_urls.csv
        git add linkedin_urls.xlsx 2>/dev/null || true  # Ignore si inexistant
        
        # Commit seulement s'il y a des changements
        if git diff --staged --quiet; then
          echo "ğŸ“ Aucun changement Ã  committer"
        else
          git commit -m "ğŸ”„ Update LinkedIn monitoring data [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push
          echo "âœ… Changements sauvegardÃ©s"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Summary
      run: |
        echo "=============================================="
        echo "ğŸ RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
        echo "=============================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "âœ… Agent LinkedIn exÃ©cutÃ© avec succÃ¨s"
        echo "=============================================="
