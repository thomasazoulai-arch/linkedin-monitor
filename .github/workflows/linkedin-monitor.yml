name: LinkedIn Monitor Production

# âœ… PERMISSIONS OBLIGATOIRES - SOLUTION AU PROBLÃˆME 403
permissions:
  contents: write      # Permission d'Ã©crire dans le repository
  actions: read        # Permission de lire les actions
  checks: read         # Permission de lire les vÃ©rifications
  pull-requests: write # Permission pour les PR si nÃ©cessaire

on:
  schedule:
    # ExÃ©cution optimisÃ©e toutes les 8 heures pour Ã©viter les limitations
    - cron: '0 6,14,22 * * *'  # 6h00, 14h00 et 22h00 UTC
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer l execution mÃªme sans changement'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Mode debug avec logs dÃ©taillÃ©s'
        required: false
        default: 'false'
        type: boolean

# Variables d'environnement globales optimisÃ©es
env:
  PYTHON_VERSION: '3.11'
  TIMEOUT_MINUTES: 30
  PIP_CACHE_DIR: /tmp/.pip-cache

jobs:
  linkedin-monitor:
    name: ğŸ¤– LinkedIn Monitoring Agent Expert
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: false
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        # Assure que les modifications peuvent Ãªtre poussÃ©es
        persist-credentials: true
    
    - name: ğŸ Configuration Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ Installation optimisÃ©e des dÃ©pendances
      run: |
        echo "ğŸ”§ Installation des dÃ©pendances Python optimisÃ©e..."
        python -m pip install --upgrade pip setuptools wheel
        
        # Installation depuis requirements.txt avec cache
        if [ -f requirements.txt ]; then
          pip install --no-cache-dir --upgrade -r requirements.txt
        else
          echo "âš ï¸ requirements.txt non trouvÃ©, installation manuelle"
          pip install requests==2.31.0
        fi
        
        echo "âœ… Installation terminÃ©e"
        pip list | grep -E "(requests|urllib3|certifi)"
    
    - name: ğŸ” Diagnostic environnement avancÃ©
      run: |
        echo "=" * 60
        echo "ğŸ” DIAGNOSTIC COMPLET DE L'ENVIRONNEMENT"
        echo "=" * 60
        echo "ğŸ Python: $(python --version)"
        echo "ğŸ“… Date/Heure: $(date -u) UTC"
        echo "ğŸŒ Timezone: UTC"
        echo "ğŸ’» OS: $(uname -a)"
        echo "ğŸ’¾ MÃ©moire: $(free -h | head -n 2)"
        echo "ğŸ’½ Espace disque: $(df -h . | tail -1)"
        echo "ğŸŒ IP publique: $(curl -s ifconfig.me || echo 'Non disponible')"
        echo ""
        
        echo "ğŸ“‚ Structure du projet:"
        ls -la
        echo ""
        
        if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
          echo "ğŸ› MODE DEBUG ACTIVÃ‰"
          echo "ğŸ“‹ Variables d'environnement (filtrÃ©es):"
          env | grep -E "(GITHUB_|RUNNER_)" | head -10
          echo ""
        fi
        
        echo "ğŸ“„ Contenu CSV actuel:"
        if [ -f "linkedin_urls.csv" ]; then
          echo "âœ… Fichier trouvÃ© ($(wc -l < linkedin_urls.csv) lignes)"
          echo "--- AperÃ§u (3 premiÃ¨res lignes) ---"
          head -3 linkedin_urls.csv
        else
          echo "âŒ linkedin_urls.csv manquant - sera crÃ©Ã© automatiquement"
        fi
        echo "=" * 60
    
    - name: ğŸ” Validation secrets et configuration
      run: |
        echo "ğŸ” Validation de la configuration sÃ©curisÃ©e..."
        
        # Fonction de validation sans exposition des valeurs
        validate_secret() {
          local name=$1
          local value=$2
          if [ -n "$value" ] && [ ${#value} -gt 3 ]; then
            echo "âœ… $name: ConfigurÃ© (${#value} caractÃ¨res)"
            return 0
          else
            echo "âŒ $name: Manquant ou trop court"
            return 1
          fi
        }
        
        # Validation de chaque secret
        VALIDATION_FAILED=0
        
        validate_secret "GMAIL_EMAIL" "${{ secrets.GMAIL_EMAIL }}" || VALIDATION_FAILED=1
        validate_secret "GMAIL_APP_PASSWORD" "${{ secrets.GMAIL_APP_PASSWORD }}" || VALIDATION_FAILED=1
        validate_secret "RECIPIENT_EMAIL" "${{ secrets.RECIPIENT_EMAIL }}" || VALIDATION_FAILED=1
        
        if [ $VALIDATION_FAILED -eq 1 ]; then
          echo ""
          echo "âŒ CONFIGURATION INCOMPLÃˆTE"
          echo "ğŸ’¡ Actions Ã  effectuer:"
          echo "   1. Aller dans Settings â†’ Secrets and variables â†’ Actions"
          echo "   2. VÃ©rifier que tous les secrets sont bien configurÃ©s"
          echo "   3. Pour GMAIL_APP_PASSWORD, utiliser un mot de passe d'application Gmail"
          exit 1
        fi
        
        echo "âœ… Tous les secrets sont correctement configurÃ©s"
    
    - name: ğŸ”§ Test des permissions Git
      run: |
        echo "ğŸ”§ Configuration et test des permissions Git..."
        
        # Configuration Git sÃ©curisÃ©e
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git config --local init.defaultBranch main
        git config --local core.autocrlf false
        
        # Test des permissions
        echo "ğŸ” Test des permissions Git..."
        git status
        
        # VÃ©rification de la configuration
        echo "ğŸ“‹ Configuration Git:"
        echo "   Email: $(git config user.email)"
        echo "   Nom: $(git config user.name)"
        echo "   Remote: $(git remote get-url origin)"
        
        echo "âœ… Git configurÃ© et permissions vÃ©rifiÃ©es"
    
    - name: ğŸ¤– ExÃ©cution de l'Agent LinkedIn Expert
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        FORCE_RUN: ${{ github.event.inputs.force_run }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸš€ Lancement de l'Agent LinkedIn Monitoring Expert..."
        echo "ğŸƒ Run #$GITHUB_RUN_NUMBER (ID: $GITHUB_RUN_ID)"
        echo "ğŸ“¦ Repository: $GITHUB_REPOSITORY"
        echo "ğŸ”§ Force run: ${FORCE_RUN:-false}"
        echo "ğŸ› Debug mode: ${DEBUG_MODE:-false}"
        echo ""
        
        # Lancement avec gestion d'erreur amÃ©liorÃ©e
        START_TIME=$(date +%s)
        
        if python linkedin_monitor.py; then
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Agent exÃ©cutÃ© avec succÃ¨s!"
          echo "â±ï¸ DurÃ©e: ${DURATION}s"
        else
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âŒ Ã‰chec de l'agent (code: $EXIT_CODE, durÃ©e: ${DURATION}s)"
          
          # Log des derniÃ¨res lignes pour diagnostic
          if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
            echo "ğŸ” Diagnostic d'erreur activÃ©"
          fi
          
          exit $EXIT_CODE
        fi
    
    - name: ğŸ’¾ Sauvegarde sÃ©curisÃ©e des modifications
      if: always()  # ExÃ©cute mÃªme en cas d'Ã©chec partiel
      run: |
        echo "ğŸ’¾ VÃ©rification et sauvegarde des modifications..."
        
        # VÃ©rification du statut Git
        echo "ğŸ“‹ Statut Git actuel:"
        git status --porcelain
        
        # VÃ©rification des fichiers modifiÃ©s
        if [ -f "linkedin_urls.csv" ]; then
          git add linkedin_urls.csv
          echo "âœ… CSV ajoutÃ© au staging"
        else
          echo "âš ï¸ Aucun fichier CSV Ã  ajouter"
        fi
        
        # Commit conditionnel avec informations enrichies
        if git diff --staged --quiet; then
          echo "ğŸ“ Aucune modification Ã  sauvegarder"
        else
          echo "ğŸ’¾ Sauvegarde des modifications en cours..."
          
          # Message de commit informatif
          COMMIT_MSG="ğŸ”„ LinkedIn monitoring update

          â€¢ Run: #${{ github.run_number }} (ID: ${{ github.run_id }})
          â€¢ Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â€¢ Trigger: ${{ github.event_name }}
          â€¢ Branch: ${{ github.ref_name }}
          $(if [ '${{ github.event_name }}' = 'workflow_dispatch' ]; then echo 'â€¢ Manual trigger: force_run=${{ github.event.inputs.force_run }}'; fi)
          
          Automated LinkedIn profile monitoring update"
          
          git commit -m "$COMMIT_MSG"
          
          # Push sÃ©curisÃ© avec retry intelligent
          echo "ğŸ“¤ Envoi vers GitHub..."
          PUSH_SUCCESS=false
          
          for attempt in {1..5}; do
            echo "ğŸ”„ Tentative de push $attempt/5..."
            
            if git push origin HEAD; then
              echo "âœ… Modifications poussÃ©es vers GitHub (tentative $attempt)"
              PUSH_SUCCESS=true
              break
            else
              PUSH_EXIT_CODE=$?
              echo "âš ï¸ Ã‰chec push tentative $attempt/5 (code: $PUSH_EXIT_CODE)"
              
              if [ $attempt -lt 5 ]; then
                WAIT_TIME=$((attempt * 10))
                echo "â³ Attente ${WAIT_TIME}s avant nouvelle tentative..."
                sleep $WAIT_TIME
                
                # Tentative de synchronisation en cas de conflit
                if [ $PUSH_EXIT_CODE -eq 1 ]; then
                  echo "ğŸ”„ Tentative de synchronisation..."
                  git pull --rebase origin HEAD || echo "âš ï¸ Rebase Ã©chouÃ©"
                fi
              fi
            fi
          done
          
          if [ "$PUSH_SUCCESS" != "true" ]; then
            echo "âŒ Ã‰CHEC CRITIQUE: Impossible de pousser aprÃ¨s 5 tentatives"
            echo "ğŸ” Diagnostic:"
            echo "   â€¢ VÃ©rifiez les permissions du repository"
            echo "   â€¢ VÃ©rifiez la section 'permissions' du workflow"
            echo "   â€¢ Token utilisÃ©: GITHUB_TOKEN (builtin)"
            exit 1
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“Š Rapport d'exÃ©cution complet
      if: always()
      run: |
        echo ""
        echo "=" * 80
        echo "ğŸ“Š RAPPORT D'EXÃ‰CUTION FINAL DÃ‰TAILLÃ‰"
        echo "=" * 80
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
        echo "ğŸ“… DÃ©but: ${{ github.event.head_commit.timestamp }}"
        echo "ğŸ“… Fin: $(date -u)"
        echo "ğŸƒ Run: #${{ github.run_number }} (ID: ${{ github.run_id }})"
        echo "âš™ï¸ DÃ©clencheur: ${{ github.event_name }}"
        echo "ğŸ‘¤ Acteur: ${{ github.actor }}"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ›ï¸ ParamÃ¨tres manuels:"
          echo "   â€¢ Force run: ${{ github.event.inputs.force_run }}"
          echo "   â€¢ Debug mode: ${{ github.event.inputs.debug_mode }}"
        fi
        
        # Statut du job avec couleurs
        case "${{ job.status }}" in
          "success")
            echo "âœ… STATUT: SUCCÃˆS COMPLET"
            ;;
          "failure")
            echo "âŒ STATUT: Ã‰CHEC"
            ;;
          "cancelled")
            echo "ğŸš« STATUT: ANNULÃ‰"
            ;;
          *)
            echo "â“ STATUT: ${{ job.status }}"
            ;;
        esac
        
        # Informations sur les fichiers finaux
        echo ""
        echo "ğŸ“ Ã‰tat final des fichiers:"
        if [ -f "linkedin_urls.csv" ]; then
          LINE_COUNT=$(wc -l < linkedin_urls.csv)
          FILE_SIZE=$(du -h linkedin_urls.csv | cut -f1)
          echo "âœ… linkedin_urls.csv: $LINE_COUNT lignes, $FILE_SIZE"
        else
          echo "âŒ linkedin_urls.csv: Manquant"
        fi
        
        # Liens utiles
        echo ""
        echo "ğŸ”— Liens utiles:"
        echo "   â€¢ Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   â€¢ Repository: ${{ github.server_url }}/${{ github.repository }}"
        echo "   â€¢ Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
        
        echo "=" * 80
        echo "ğŸ Fin du rapport d'exÃ©cution"
        echo "=" * 80
    
    - name: ğŸš¨ Notification d'Ã©chec avancÃ©e
      if: failure()
      run: |
        echo ""
        echo "ğŸš¨" "=" * 60 "ğŸš¨"
        echo "ğŸš¨ Ã‰CHEC DÃ‰TECTÃ‰ - DIAGNOSTIC COMPLET"
        echo "ğŸš¨" "=" * 60 "ğŸš¨"
        
        echo "ğŸ“‹ Informations de l'Ã©chec:"
        echo "   â€¢ Repository: ${{ github.repository }}"
        echo "   â€¢ Branche: ${{ github.ref_name }}"
        echo "   â€¢ Run ID: ${{ github.run_id }}"
        echo "   â€¢ Commit: ${{ github.sha }}"
        echo "   â€¢ Acteur: ${{ github.actor }}"
        echo "   â€¢ Timestamp: $(date -u)"
        
        echo ""
        echo "ğŸ” Diagnostic suggÃ©rÃ©:"
        echo "   1. ğŸ” VÃ©rifier la configuration des secrets GitHub"
        echo "   2. ğŸŒ ContrÃ´ler la connectivitÃ© rÃ©seau et les URLs LinkedIn"
        echo "   3. ğŸ“§ Tester l'envoi d'emails avec les identifiants configurÃ©s"
        echo "   4. ğŸ› Activer le mode debug pour plus d'informations"
        echo "   5. ğŸ“ Consulter les logs dÃ©taillÃ©s via le lien ci-dessous"
        
        echo ""
        echo "ğŸ“ Actions de rÃ©cupÃ©ration:"
        echo "   â€¢ Relancer manuellement: Repository â†’ Actions â†’ ${{ github.workflow }} â†’ Run workflow"
        echo "   â€¢ Mode debug: Cocher 'Mode debug' lors du lancement manuel"
        echo "   â€¢ VÃ©rifier secrets: Settings â†’ Secrets and variables â†’ Actions"
        
        echo ""
        echo "ğŸ”— Lien direct vers les logs:"
        echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        echo "ğŸš¨" "=" * 60 "ğŸš¨"
        
        # N'Ã©choue pas le workflow pour la notification
        exit 0
