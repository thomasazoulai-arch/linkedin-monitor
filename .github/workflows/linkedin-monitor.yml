name: LinkedIn API Monitor v4.0

on:
  schedule:
    # ExÃ©cution optimisÃ©e toutes les 6 heures pour respecter les quotas API
    - cron: '0 6,12,18,0 * * *'
  workflow_dispatch:  # ExÃ©cution manuelle
    inputs:
      debug_mode:
        description: 'Activer le mode debug API'
        required: false
        default: 'false'
      force_auth:
        description: 'Forcer la rÃ©authentification'
        required: false
        default: 'false'

# Permissions Ã©tendues pour API
permissions:
  contents: write
  actions: read
  id-token: write  # Pour l'authentification avancÃ©e

env:
  # Configuration API LinkedIn
  LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
  LINKEDIN_CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
  LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
  
  # Configuration email
  GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
  GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
  RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
  
  # Configuration monitoring
  DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
  MAX_POSTS_PER_PROFILE: 10
  API_DELAY_SECONDS: 20

jobs:
  linkedin-api-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Timeout Ã©tendu pour API
    
    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ Setup Python avec Cache
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Version plus rÃ©cente pour l'API
        cache: 'pip'
    
    - name: ğŸ“¦ Install API Dependencies
      run: |
        echo "ğŸ“¦ Installation des dÃ©pendances API LinkedIn..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… DÃ©pendances API installÃ©es avec succÃ¨s"
    
    - name: ğŸ” Validate API Configuration
      run: |
        echo "ğŸ” Validation de la configuration API LinkedIn..."
        
        # VÃ©rification des variables obligatoires
        if [ -z "$LINKEDIN_CLIENT_ID" ]; then
          echo "âŒ LINKEDIN_CLIENT_ID manquant"
          exit 1
        fi
        
        if [ -z "$LINKEDIN_CLIENT_SECRET" ]; then
          echo "âŒ LINKEDIN_CLIENT_SECRET manquant"
          exit 1
        fi
        
        echo "âœ… Configuration API valide"
        echo "ğŸ”‘ Client ID: ${LINKEDIN_CLIENT_ID:0:8}***"
        echo "ğŸ”’ Client Secret: ConfigurÃ©"
        echo "ğŸ¯ Token Access: ${LINKEDIN_ACCESS_TOKEN:+Fourni}"
    
    - name: ğŸ“Š Check Data Files
      run: |
        echo "ğŸ“Š VÃ©rification des fichiers de donnÃ©es..."
        
        if [ -f "linkedin_urls.csv" ]; then
          echo "âœ… Fichier CSV existant:"
          head -3 linkedin_urls.csv
          echo "ğŸ“ˆ Nombre de profils: $(( $(wc -l < linkedin_urls.csv) - 1 ))"
        else
          echo "ğŸ†• Nouveau fichier CSV - sera crÃ©Ã© avec profils par dÃ©faut"
        fi
        
        echo "ğŸ“ Espace disque disponible:"
        df -h . | head -2
    
    - name: ğŸš€ Run LinkedIn API Monitor
      run: |
        echo "ğŸš€ Lancement du LinkedIn API Monitor v4.0..."
        echo "âš¡ Mode: ${{ github.event.inputs.debug_mode == 'true' && 'DEBUG' || 'PRODUCTION' }}"
        echo "ğŸ”„ RÃ©auth forcÃ©e: ${{ github.event.inputs.force_auth || 'false' }}"
        
        # ExÃ©cution avec gestion d'erreur robuste
        python linkedin_monitor.py 2>&1 | tee api_monitor.log
        
        # VÃ©rification du rÃ©sultat
        if [ $? -eq 0 ]; then
          echo "âœ… Monitoring API exÃ©cutÃ© avec succÃ¨s"
        else
          echo "âš ï¸ Monitoring terminÃ© avec avertissements"
        fi
    
    - name: ğŸ“ˆ API Usage Report
      run: |
        echo "ğŸ“ˆ Rapport d'utilisation API LinkedIn..."
        
        if [ -f "api_monitor.log" ]; then
          echo "ğŸ“Š Statistiques extraites du log:"
          
          # Extraction des mÃ©triques
          POSTS_FOUND=$(grep -c "posts API extraits" api_monitor.log || echo "0")
          API_CALLS=$(grep -c "API Check:" api_monitor.log || echo "0")
          ERRORS=$(grep -c "Erreur API" api_monitor.log || echo "0")
          
          echo "   ğŸ¯ Posts trouvÃ©s: $POSTS_FOUND"
          echo "   ğŸ“¡ Appels API: $API_CALLS"
          echo "   âŒ Erreurs: $ERRORS"
          
          # Calcul taux de rÃ©ussite
          if [ "$API_CALLS" -gt 0 ]; then
            SUCCESS_RATE=$(( (API_CALLS - ERRORS) * 100 / API_CALLS ))
            echo "   ğŸ“ˆ Taux de rÃ©ussite: ${SUCCESS_RATE}%"
          fi
        fi
        
        echo "â° Prochaine exÃ©cution: $(date -d '+6 hours' '+%Y-%m-%d %H:%M UTC')"
    
    - name: ğŸ’¾ Commit API Data Changes
      run: |
        echo "ğŸ’¾ Sauvegarde des donnÃ©es API..."
        
        # Configuration Git
        git config --local user.email "api-monitor@github.com"
        git config --local user.name "LinkedIn API Monitor v4.0"
        
        # VÃ©rification des changements
        echo "ğŸ“Š Statut avant commit:"
        git status --porcelain
        
        # Ajout des fichiers de donnÃ©es
        if [ -f "linkedin_urls.csv" ]; then
          git add linkedin_urls.csv
          echo "âœ… CSV mis Ã  jour"
        fi
        
        # Ajout du log si mode debug
        if [ "$DEBUG_MODE" = "true" ] && [ -f "api_monitor.log" ]; then
          git add api_monitor.log
          echo "ğŸ› Log debug ajoutÃ©"
        fi
        
        # Commit intelligent
        if ! git diff --staged --quiet; then
          echo "ğŸ’¾ CrÃ©ation du commit API..."
          
          # Pull des changements distants
          git pull origin ${{ github.ref_name }} --rebase || echo "â„¹ï¸ Aucun changement distant"
          
          # Commit avec mÃ©tadonnÃ©es enrichies
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          POSTS_COUNT=$(grep -c "posts authentiques extraits" api_monitor.log 2>/dev/null || echo "0")
          
          git commit -m "ğŸš€ LinkedIn API Monitor v4.0 - Mise Ã  jour [$TIMESTAMP]

ğŸ”¥ Monitoring via API officielle LinkedIn:
ğŸ“Š Posts authentiques dÃ©tectÃ©s: $POSTS_COUNT
ğŸ” Authentification: OAuth 2.0
ğŸ“¡ API: LinkedIn v2 + UGC Posts
ğŸ¯ Extraction: Titres et descriptions authentiques
ğŸ¨ Notification: Email ultra-premium

ğŸ¤– Agent: GitHub Actions API Monitor
âš¡ Version: 4.0 RÃ©volutionnaire
ğŸŒ Timestamp: $TIMESTAMP"
          
          # Push avec retry automatique
          echo "ğŸš€ Push vers GitHub..."
          for i in {1..3}; do
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… Push API rÃ©ussi (tentative $i)"
              break
            else
              echo "âš ï¸ Tentative $i Ã©chouÃ©e, retry dans 10s..."
              sleep 10
              git pull origin ${{ github.ref_name }} --rebase
            fi
          done
        else
          echo "ğŸ“ Aucune modification de donnÃ©es Ã  committer"
        fi
    
    - name: ğŸ” API Health Check
      run: |
        echo "ğŸ” VÃ©rification de la santÃ© de l'API..."
        
        # VÃ©rification de l'Ã©tat du repository
        echo "ğŸ“Š Ã‰tat final du repository:"
        git log --oneline -3
        echo ""
        echo "ğŸ“ Fichiers de donnÃ©es prÃ©sents:"
        ls -la *.csv *.xlsx *.log 2>/dev/null || echo "Aucun fichier de donnÃ©es"
        
        # VÃ©rification de la taille des fichiers
        if [ -f "linkedin_urls.csv" ]; then
          SIZE=$(wc -c < linkedin_urls.csv)
          echo "ğŸ“ Taille CSV: $SIZE bytes"
          
          if [ "$SIZE" -lt 100 ]; then
            echo "âš ï¸ ATTENTION: Fichier CSV trÃ¨s petit - VÃ©rifiez les donnÃ©es"
          fi
        fi
        
        # Estimation du quota API utilisÃ©
        if [ -f "api_monitor.log" ]; then
          API_CALLS=$(grep -c "API Check:" api_monitor.log 2>/dev/null || echo "0")
          echo "ğŸ“Š Appels API effectuÃ©s: $API_CALLS"
          echo "ğŸ“ˆ Quota estimÃ© utilisÃ©: $(( API_CALLS * 2 )) points"
        fi
    
    - name: ğŸ¯ Deployment Summary
      run: |
        echo "=============================================================="
        echo "ğŸ‰ RÃ‰SUMÃ‰ LINKEDIN API MONITOR v4.0"
        echo "=============================================================="
        echo "ğŸ“… ExÃ©cution: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ” API LinkedIn: IntÃ©gration officielle v2"
        echo "ğŸ“¡ Endpoints: UGC Posts + Organizations"
        echo "ğŸ¯ Extraction: Contenu 100% authentique"
        echo "âš¡ OAuth 2.0: Authentification sÃ©curisÃ©e"
        echo "ğŸ¨ Email: Design ultra-premium avec donnÃ©es rÃ©elles"
        echo "ğŸ¤– Intelligence: Analyse avancÃ©e des posts"
        echo ""
        echo "ğŸ”¥ AVANTAGES VERSION API:"
        echo "   â€¢ Vrais titres et descriptions des posts"
        echo "   â€¢ DonnÃ©es d'engagement temps rÃ©el"
        echo "   â€¢ Contournement des limitations de scraping"
        echo "   â€¢ Respect des conditions d'utilisation LinkedIn"
        echo "   â€¢ FiabilitÃ© et stabilitÃ© maximales"
        echo "   â€¢ Support officiel des Company Pages"
        echo "=============================================================="
        
        # Badge de succÃ¨s
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸŸ¢ STATUT: SUCCÃˆS COMPLET"
        else
          echo "ğŸŸ¡ STATUT: TERMINÃ‰ AVEC AVERTISSEMENTS"
        fi
        
        echo "ğŸš€ Prochaine exÃ©cution automatique: $(date -d '+6 hours' '+%Y-%m-%d %H:%M UTC')"
        echo "=============================================================="

    # Ã‰tape optionnelle: Notification Slack/Discord en cas d'erreur critique
    - name: ğŸš¨ Critical Error Notification
      if: failure()
      run: |
        echo "ğŸš¨ ERREUR CRITIQUE DÃ‰TECTÃ‰E"
        echo "Le monitoring API LinkedIn a rencontrÃ© une erreur critique."
        echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails."
        echo ""
        echo "Actions recommandÃ©es:"
        echo "1. VÃ©rifier la validitÃ© des tokens API LinkedIn"
        echo "2. ContrÃ´ler les quotas API restants"
        echo "3. Valider la configuration des secrets GitHub"
        echo "4. Consulter la documentation LinkedIn API"
        
        # Log d'erreur pour debug
        if [ -f "api_monitor.log" ]; then
          echo ""
          echo "ğŸ“‹ DerniÃ¨res lignes du log:"
          tail -10 api_monitor.log
        fi
