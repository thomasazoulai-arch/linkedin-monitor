name: LinkedIn Monitor API v4.0 - Basic

on:
  schedule:
    - cron: '0 6,12,18,0 * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Debug mode'
        required: false
        default: 'false'

permissions:
  contents: write
  actions: read

env:
  LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
  LINKEDIN_CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
  GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
  GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
  RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        echo "ðŸ“¦ Installation des dÃ©pendances..."
        pip install requests==2.31.0 python-dateutil==2.8.2
        echo "âœ… DÃ©pendances installÃ©es"
    
    - name: Debug LinkedIn Products
      run: |
        echo "ðŸ” Debug des produits LinkedIn disponibles..."
        echo "Client ID: ${LINKEDIN_CLIENT_ID:0:8}***"
        echo "Secret length: ${#LINKEDIN_CLIENT_SECRET}"
        
        echo "ðŸ§ª Test avec diffÃ©rentes permissions..."
        
        # Test 1: r_liteprofile (basique)
        echo "Test 1: r_liteprofile"
        curl -s -X POST https://www.linkedin.com/oauth/v2/accessToken \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials" \
          -d "client_id=$LINKEDIN_CLIENT_ID" \
          -d "client_secret=$LINKEDIN_CLIENT_SECRET" \
          -d "scope=r_liteprofile" \
          -w "Status: %{http_code}\n"
        
        echo ""
        
        # Test 2: r_organization_social (entreprises)
        echo "Test 2: r_organization_social"
        curl -s -X POST https://www.linkedin.com/oauth/v2/accessToken \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials" \
          -d "client_id=$LINKEDIN_CLIENT_ID" \
          -d "client_secret=$LINKEDIN_CLIENT_SECRET" \
          -d "scope=r_organization_social" \
          -w "Status: %{http_code}\n"
        
        echo ""
        
        # Test 3: w_member_social (partage)
        echo "Test 3: w_member_social"
        curl -s -X POST https://www.linkedin.com/oauth/v2/accessToken \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials" \
          -d "client_id=$LINKEDIN_CLIENT_ID" \
          -d "client_secret=$LINKEDIN_CLIENT_SECRET" \
          -d "scope=w_member_social" \
          -w "Status: %{http_code}\n"
        
        echo ""
        
        # Test 4: Sans scope spÃ©cifique
        echo "Test 4: Sans scope"
        curl -s -X POST https://www.linkedin.com/oauth/v2/accessToken \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials" \
          -d "client_id=$LINKEDIN_CLIENT_ID" \
          -d "client_secret=$LINKEDIN_CLIENT_SECRET" \
          -w "Status: %{http_code}\n"
    
    - name: Test LinkedIn API Access
      run: |
        echo "ðŸ” Test d'accÃ¨s API LinkedIn..."
        
        # Essai d'authentification avec scope minimal
        TOKEN_RESPONSE=$(curl -s -X POST https://www.linkedin.com/oauth/v2/accessToken \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials" \
          -d "client_id=$LINKEDIN_CLIENT_ID" \
          -d "client_secret=$LINKEDIN_CLIENT_SECRET" \
          -d "scope=r_liteprofile")
        
        echo "Response: $TOKEN_RESPONSE"
        
        if echo "$TOKEN_RESPONSE" | grep -q "access_token"; then
          echo "âœ… Token obtenu avec r_liteprofile"
          
          # Extraction du token
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
          echo "Token: ${ACCESS_TOKEN:0:20}..."
          
          # Test d'une requÃªte simple
          echo "ðŸ§ª Test requÃªte API..."
          curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "X-Restli-Protocol-Version: 2.0.0" \
            "https://api.linkedin.com/v2/me" \
            -w "Status: %{http_code}\n"
        else
          echo "âŒ Impossible d'obtenir un token"
        fi
    
    - name: Check LinkedIn Developer Portal
      run: |
        echo "ðŸ“‹ INFORMATIONS IMPORTANTES:"
        echo "=========================================="
        echo "ðŸ” VÃ©rifiez votre LinkedIn Developer App:"
        echo "1. Allez sur https://www.linkedin.com/developers/"
        echo "2. Cliquez sur votre app"
        echo "3. Onglet 'Products'"
        echo "4. Listez TOUS les produits disponibles"
        echo ""
        echo "Produits Ã  chercher:"
        echo "âœ… Sign In with LinkedIn"
        echo "ðŸŽ¯ Share on LinkedIn"
        echo "ðŸŽ¯ Advertising API"
        echo "ðŸŽ¯ Community Management API"
        echo "ðŸŽ¯ Content API"
        echo "ðŸŽ¯ Tout produit contenant 'Organization' ou 'Company'"
        echo ""
        echo "âš ï¸ Si aucun produit n'est 'Approved' (vert),"
        echo "   c'est normal pour une nouvelle app."
        echo "=========================================="
    
    - name: Send Debug Email
      run: |
        echo "ðŸ“§ Envoi email de debug..."
        
        cat > debug_email.py << 'EOF'
        import smtplib, os
        from email.mime.text import MIMEText
        from datetime import datetime
        
        sender = os.getenv('GMAIL_EMAIL')
        password = os.getenv('GMAIL_APP_PASSWORD')
        recipient = os.getenv('RECIPIENT_EMAIL')
        
        if sender and password and recipient:
            msg = MIMEText(f"""
            ðŸ” LinkedIn API Debug Report
            
            Date: {datetime.now()}
            
            Status: En cours de configuration
            
            Actions requises:
            1. VÃ©rifier les produits LinkedIn disponibles
            2. Approuver les permissions nÃ©cessaires
            3. Re-tester l'authentification
            
            Le systÃ¨me est prÃªt, il faut juste finaliser
            les permissions LinkedIn.
            
            LinkedIn Monitor v4.0
            """)
            
            msg['Subject'] = 'ðŸ” LinkedIn API - Debug Report'
            msg['From'] = sender
            msg['To'] = recipient
            
            try:
                with smtplib.SMTP('smtp.gmail.com', 587) as server:
                    server.starttls()
                    server.login(sender, password)
                    server.send_message(msg)
                print("âœ… Email debug envoyÃ©")
            except Exception as e:
                print(f"âŒ Erreur email: {e}")
        else:
            print("âŒ Configuration email manquante")
        EOF
        
        python debug_email.py
    
    - name: Summary
      run: |
        echo "=========================================="
        echo "ðŸ” DIAGNOSTIC LINKEDIN API v4.0"
        echo "=========================================="
        echo "ðŸ“… $(date)"
        echo "ðŸ”‘ Client ID: ConfigurÃ©"
        echo "ðŸ”’ Client Secret: ConfigurÃ©"
        echo "ðŸ“§ Email: Configuration testÃ©e"
        echo ""
        echo "ðŸŽ¯ PROCHAINES Ã‰TAPES:"
        echo "1. VÃ©rifiez les logs ci-dessus"
        echo "2. Consultez votre LinkedIn Developer App"
        echo "3. Activez les produits appropriÃ©s"
        echo "4. Re-testez le workflow"
        echo "=========================================="
