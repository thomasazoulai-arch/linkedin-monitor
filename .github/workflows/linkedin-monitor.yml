name: LinkedIn Monitor Agent

on:
  schedule:
    # ExÃ©cution toutes les 12 heures (Ã  8h00 et 20h00 UTC)
    - cron: '0 8,20 * * *'
  workflow_dispatch:  # Permet l'exÃ©cution manuelle
    inputs:
      debug_mode:
        description: 'Activer le mode debug'
        required: false
        default: 'false'

# CORRECTION 1: Ajout des permissions nÃ©cessaires
permissions:
  contents: write  # Permission d'Ã©criture sur le repository
  actions: read    # Permission de lecture des actions

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de sÃ©curitÃ©
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        # CORRECTION 2: Utilisation d'un token avec permissions Ã©tendues
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique pour Ã©viter les conflits
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… DÃ©pendances installÃ©es"
    
    - name: ğŸ“Š Check files
      run: |
        echo "ğŸ“‚ Fichiers prÃ©sents:"
        ls -la
        echo "ğŸ“ Contenu du CSV:"
        if [ -f "linkedin_urls.csv" ]; then
          head -5 linkedin_urls.csv
        else
          echo "âŒ Fichier CSV manquant - sera crÃ©Ã© automatiquement"
        fi
    
    - name: ğŸ¤– Run LinkedIn Monitor Agent
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        echo "ğŸš€ Lancement de l'agent LinkedIn..."
        python linkedin_monitor.py
    
    # CORRECTION 3: AmÃ©lioration de la gestion Git avec vÃ©rifications
    - name: ğŸ’¾ Commit and push changes
      run: |
        # Configuration Git avec informations dÃ©taillÃ©es
        git config --local user.email "action@github.com"
        git config --local user.name "LinkedIn Monitor Agent"
        
        # VÃ©rification du statut Git
        echo "ğŸ“Š Statut Git avant modification:"
        git status
        
        # Ajout des fichiers modifiÃ©s avec vÃ©rification
        echo "ğŸ“ Ajout des fichiers modifiÃ©s..."
        git add linkedin_urls.csv
        
        # Ajout conditionnel du fichier Excel s'il existe
        if [ -f "linkedin_urls.xlsx" ]; then
          git add linkedin_urls.xlsx
          echo "âœ… Fichier Excel ajoutÃ©"
        fi
        
        # VÃ©rification des changements avant commit
        echo "ğŸ“Š Statut aprÃ¨s ajout:"
        git status
        
        # Commit seulement s'il y a des changements
        if git diff --staged --quiet; then
          echo "ğŸ“ Aucun changement Ã  committer"
        else
          echo "ğŸ’¾ CrÃ©ation du commit..."
          
          # CORRECTION 4: Gestion plus robuste des conflits
          # Pull avant push pour Ã©viter les conflits
          git pull origin ${{ github.ref_name }} --rebase || echo "âš ï¸ Pas de changements distants"
          
          # Commit avec message dÃ©taillÃ©
          git commit -m "ğŸ”„ Update LinkedIn monitoring data [$(date '+%Y-%m-%d %H:%M:%S UTC')]
          
          ğŸ“Š RÃ©sumÃ©:
          - Surveillance automatique LinkedIn
          - Mise Ã  jour des signatures de contenu
          - Agent: GitHub Actions Bot
          - Timestamp: $(date -u)"
          
          # Push avec gestion d'erreur amÃ©liorÃ©e
          echo "ğŸš€ Push vers GitHub..."
          if git push origin ${{ github.ref_name }}; then
            echo "âœ… Changements sauvegardÃ©s avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du push - Tentative de rÃ©solution..."
            
            # Tentative de rÃ©solution automatique
            git pull origin ${{ github.ref_name }} --rebase
            git push origin ${{ github.ref_name }}
            
            if [ $? -eq 0 ]; then
              echo "âœ… Push rÃ©ussi aprÃ¨s rÃ©solution"
            else
              echo "ğŸ’¥ Ã‰chec final du push"
              exit 1
            fi
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # CORRECTION 5: Ajout d'une Ã©tape de vÃ©rification finale
    - name: ğŸ” Verify repository state
      run: |
        echo "ğŸ” VÃ©rification finale du repository:"
        git log --oneline -3
        echo "ğŸ“Š Statut final:"
        git status
        echo "ğŸ“ Fichiers dans le repository:"
        ls -la *.csv *.xlsx 2>/dev/null || echo "Aucun fichier de donnÃ©es"
    
    - name: ğŸ“‹ Summary
      run: |
        echo "=============================================="
        echo "ğŸ RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION CORRIGÃ‰E"
        echo "=============================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ”‘ Permissions: contents:write activÃ©es"
        echo "âœ… Agent LinkedIn exÃ©cutÃ© avec succÃ¨s"
        echo "ğŸ’¾ Gestion Git amÃ©liorÃ©e"
        echo "=============================================="
