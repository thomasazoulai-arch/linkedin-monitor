name: LinkedIn Monitor Production

on:
  schedule:
    # ExÃ©cution toutes les 12 heures (optimisÃ© pour Ã©viter les limitations)
    - cron: '0 6,18 * * *'  # 6h00 et 18h00 UTC
  workflow_dispatch:  # Permet l'exÃ©cution manuelle pour tests
    inputs:
      force_run:
        description: 'Forcer lexecution meme sans changement'
        required: false
        default: 'false'
        type: boolean

# Variables d'environnement globales
env:
  PYTHON_VERSION: '3.11'
  TIMEOUT_MINUTES: 25

jobs:
  linkedin-monitor:
    name: ğŸ¤– Agent LinkedIn Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    # StratÃ©gie de gestion d'erreur
    continue-on-error: false
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
    
    - name: ğŸ Configuration Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        echo "ğŸ”§ Installation des dÃ©pendances Python..."
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        echo "âœ… DÃ©pendances installÃ©es avec succÃ¨s"
        
        # VÃ©rification des packages
        echo "ğŸ“‹ Packages installÃ©s:"
        pip list
    
    - name: ğŸ” Diagnostic de l'environnement
      run: |
        echo "=" * 50
        echo "ğŸ” DIAGNOSTIC ENVIRONNEMENT"
        echo "=" * 50
        echo "ğŸ Version Python: $(python --version)"
        echo "ğŸ“… Date/Heure: $(date)"
        echo "ğŸŒ Timezone: $(timedatectl show --property=Timezone --value 2>/dev/null || echo 'UTC')"
        echo "ğŸ’¾ Espace disque:"
        df -h . || echo "Impossible d'obtenir l'info disque"
        echo ""
        
        echo "ğŸ“‚ Fichiers du projet:"
        ls -la
        echo ""
        
        echo "ğŸ“ Contenu CSV actuel:"
        if [ -f "linkedin_urls.csv" ]; then
          echo "âœ… Fichier CSV trouvÃ© ($(wc -l < linkedin_urls.csv) lignes)"
          head -3 linkedin_urls.csv
          if [ $(wc -l < linkedin_urls.csv) -gt 3 ]; then
            echo "..."
          fi
        else
          echo "âŒ Fichier CSV manquant - sera crÃ©Ã© automatiquement"
        fi
        echo "=" * 50
    
    - name: ğŸ” Validation des secrets
      run: |
        echo "ğŸ” Validation de la configuration..."
        
        # VÃ©rification des variables obligatoires (sans afficher les valeurs)
        if [ -z "${{ secrets.GMAIL_EMAIL }}" ]; then
          echo "âŒ GMAIL_EMAIL manquant"
          exit 1
        fi
        
        if [ -z "${{ secrets.GMAIL_APP_PASSWORD }}" ]; then
          echo "âŒ GMAIL_APP_PASSWORD manquant" 
          exit 1
        fi
        
        if [ -z "${{ secrets.RECIPIENT_EMAIL }}" ]; then
          echo "âŒ RECIPIENT_EMAIL manquant"
          exit 1
        fi
        
        echo "âœ… Tous les secrets requis sont configurÃ©s"
        echo "ğŸ“§ Email expÃ©diteur: ${{ secrets.GMAIL_EMAIL }}"
        echo "ğŸ“§ Email destinataire: ${{ secrets.RECIPIENT_EMAIL }}"
        echo "ğŸ”‘ Mot de passe: [CONFIGURÃ‰]"
    
    - name: ğŸ¤– ExÃ©cution de l'Agent LinkedIn
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        FORCE_RUN: ${{ github.event.inputs.force_run }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
      run: |
        echo "ğŸš€ Lancement de l'Agent LinkedIn Monitoring..."
        echo "ğŸ”¢ Run ID: $GITHUB_RUN_ID"
        echo "ğŸ“Š Run Number: $GITHUB_RUN_NUMBER"
        echo ""
        
        # Lancement avec gestion d'erreur
        if python linkedin_monitor.py; then
          echo ""
          echo "âœ… Agent exÃ©cutÃ© avec succÃ¨s!"
        else
          echo ""
          echo "âŒ Ã‰chec de l'agent (code: $?)"
          exit 1
        fi
    
    - name: ğŸ’¾ Sauvegarde des modifications
      if: success() || failure()  # ExÃ©cute mÃªme en cas d'Ã©chec partiel
      run: |
        echo "ğŸ’¾ VÃ©rification et sauvegarde des modifications..."
        
        # Configuration Git
        git config --local user.email "linkedin-agent@github-actions.com"
        git config --local user.name "LinkedIn Monitor Agent"
        git config --local user.signingkey ""
        git config --local commit.gpgsign false
        
        # VÃ©rification des fichiers modifiÃ©s
        echo "ğŸ“‹ Statut Git:"
        git status --porcelain
        
        # Ajout des fichiers
        git add linkedin_urls.csv 2>/dev/null || echo "âš ï¸ Pas de CSV Ã  ajouter"
        
        # Commit conditionnel
        if git diff --staged --quiet; then
          echo "ğŸ“ Aucune modification Ã  sauvegarder"
        else
          echo "ğŸ’¾ Sauvegarde des modifications..."
          COMMIT_MSG="ğŸ”„ LinkedIn monitoring update - Run #${{ github.run_number }} [$(date '+%Y-%m-%d %H:%M UTC')]"
          git commit -m "$COMMIT_MSG"
          
          # Push avec retry en cas d'Ã©chec
          for i in {1..3}; do
            if git push; then
              echo "âœ… Modifications poussÃ©es vers GitHub (tentative $i)"
              break
            else
              echo "âš ï¸ Ã‰chec push tentative $i/3"
              if [ $i -eq 3 ]; then
                echo "âŒ Impossible de pousser aprÃ¨s 3 tentatives"
                exit 1
              fi
              sleep 5
            fi
          done
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“Š Rapport d'exÃ©cution
      if: always()  # ExÃ©cute toujours, mÃªme en cas d'erreur
      run: |
        echo ""
        echo "=" * 60
        echo "ğŸ“Š RAPPORT D'EXÃ‰CUTION FINAL"
        echo "=" * 60
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸƒ Run #${{ github.run_number }} (ID: ${{ github.run_id }})"
        echo "âš™ï¸ DÃ©clencheur: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ‘¤ DÃ©clenchÃ© manuellement"
          echo "ğŸ”§ Force run: ${{ github.event.inputs.force_run }}"
        fi
        
        # Statut final
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… STATUT: SUCCÃˆS COMPLET"
        else
          echo "âŒ STATUT: Ã‰CHEC ou ERREUR"
        fi
        
        # Informations sur les fichiers
        echo ""
        echo "ğŸ“ Ã‰tat final des fichiers:"
        ls -la linkedin_urls.csv 2>/dev/null && echo "âœ… CSV prÃ©sent" || echo "âŒ CSV manquant"
        
        echo "=" * 60
        echo "ğŸ Fin du rapport d'exÃ©cution"
        echo "=" * 60
    
    - name: ğŸš¨ Notification d'Ã©chec (si erreur)
      if: failure()
      run: |
        echo "ğŸš¨ Ã‰CHEC DÃ‰TECTÃ‰ - Informations de dÃ©bogage:"
        echo "   â€¢ Run ID: ${{ github.run_id }}"
        echo "   â€¢ Commit: ${{ github.sha }}"
        echo "   â€¢ Branche: ${{ github.ref_name }}"
        echo "   â€¢ Voir les logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ”§ Actions recommandÃ©es:"
        echo "   1. VÃ©rifier les secrets GitHub"
        echo "   2. ContrÃ´ler la validitÃ© des URLs LinkedIn"
        echo "   3. Tester localement avec les mÃªmes variables"
        echo ""
        exit 0  # Ne pas faire Ã©chouer le workflow pour la notification
